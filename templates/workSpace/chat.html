{% extends 'base.html' %}

{% block content %}
{% load static %}

  <div class="container-fluid">
    <div class="card overflow-hidden chat-application">
      <div class="d-flex align-items-center justify-content-between gap-6 m-3 d-lg-none">
        <button class="btn btn-primary d-flex" type="button" data-bs-toggle="offcanvas"
          data-bs-target="#chat-sidebar" aria-controls="chat-sidebar">
          <i class="ti ti-menu-2 fs-5"></i>
        </button>
        <form class="position-relative w-100">
          <input type="text" class="form-control search-chat py-2 ps-5" id="text-srh"
            placeholder="Search Contact">
          <i class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
        </form>
      </div>
      <div class="d-flex">
        <div class="w-70 w-xs-100 chat-container">
          <div class="chat-box-inner-part h-100">
            <div class="chat-not-selected h-100 d-none">
              <div class="d-flex align-items-center justify-content-center h-100 p-5">
                <div class="text-center">
                  <span class="text-primary">
                    <i class="ti ti-message-dots fs-10"></i>
                  </span>
                  <h6 class="mt-2">Open chat from the list</h6>
                </div>
              </div>
            </div>
            <div class="chatting-box d-block">
              <div class="p-9 border-bottom chat-meta-user d-flex align-items-center justify-content-between">
                <div class="hstack gap-3 current-chat-user-name">
                  <div class="position-relative">
                    <img src="{% static 'MatDash Bootstrap Admin_files/user-3.jpg' %}" alt="user1" width="48" height="48"
                      class="rounded-circle">
                    <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-success">
                      <span class="visually-hidden">New alerts</span>
                    </span>
                  </div>
                  <div>
                    <h6 class="mb-1 name fw-semibold"></h6>
                    <p class="mb-0">Away</p>
                  </div>
                </div>
                <ul class="list-unstyled mb-0 d-flex align-items-center">
                
                      <li>
                        <a id="voiceCallButton" class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5" href="javascript:void(0)">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="m16.1 13.359l-.528-.532zm.456-.453l.529.532zm2.417-.317l-.358.66zm1.91 1.039l-.358.659zm.539 3.255l.529.532zm-1.42 1.412l-.53-.531zm-1.326.67l.07.747zm-9.86-4.238l.528-.532zM4.002 5.746l-.749.042zm6.474 1.451l.53.532zm.157-2.654l.6-.449zM9.374 2.86l-.601.45zM6.26 2.575l.53.532zm-1.57 1.56l-.528-.531zm7.372 7.362l.529-.532zm4.567 2.394l.455-.453l-1.058-1.064l-.455.453zm1.985-.643l1.91 1.039l.716-1.318l-1.91-1.038zm2.278 3.103l-1.42 1.413l1.057 1.063l1.42-1.412zm-2.286 1.867c-1.45.136-5.201.015-9.263-4.023l-1.057 1.063c4.432 4.407 8.65 4.623 10.459 4.454zm-9.263-4.023c-3.871-3.85-4.512-7.087-4.592-8.492l-1.498.085c.1 1.768.895 5.356 5.033 9.47zm1.376-6.18l.286-.286L9.95 6.666l-.287.285zm.515-3.921L9.974 2.41l-1.201.899l1.26 1.684zM5.733 2.043l-1.57 1.56l1.058 1.064l1.57-1.56zm4.458 5.44c-.53-.532-.53-.532-.53-.53h-.002l-.003.004a1 1 0 0 0-.127.157c-.054.08-.113.185-.163.318a2.1 2.1 0 0 0-.088 1.071c.134.865.73 2.008 2.256 3.526l1.058-1.064c-1.429-1.42-1.769-2.284-1.832-2.692c-.03-.194.001-.29.01-.312q.009-.02 0-.006a.3.3 0 0 1-.03.039l-.01.01l-.01.009zm1.343 4.546c1.527 1.518 2.676 2.11 3.542 2.242c.443.068.8.014 1.071-.087a1.5 1.5 0 0 0 .42-.236l.05-.045l.007-.006l.003-.003l.001-.002s.002-.001-.527-.533c-.53-.532-.528-.533-.528-.533l.002-.002l.002-.002l.006-.005l.01-.01l.038-.03q.014-.009-.007.002c-.025.009-.123.04-.32.01c-.414-.064-1.284-.404-2.712-1.824zm-1.56-9.62C8.954 1.049 6.95.834 5.733 2.044L6.79 3.107c.532-.529 1.476-.475 1.983.202zM4.752 5.704c-.02-.346.139-.708.469-1.036L4.163 3.604c-.537.534-.96 1.29-.909 2.184zm14.72 12.06c-.274.274-.57.428-.865.455l.139 1.494c.735-.069 1.336-.44 1.784-.885zM11.006 7.73c.985-.979 1.058-2.527.229-3.635l-1.201.899c.403.539.343 1.246-.085 1.673zm9.52 6.558c.817.444.944 1.49.367 2.064l1.058 1.064c1.34-1.333.927-3.557-.71-4.446zm-3.441-.849c.384-.382 1.002-.476 1.53-.19l.716-1.317c-1.084-.59-2.428-.427-3.304.443z"/></svg>
                        </a>
                      </li>
                      
                      <li>
                        <a id="videoCallButton" class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5" href="javascript:void(0)">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M9.451 3.25h.098c1.602 0 2.872 0 3.876.119c1.03.122 1.88.377 2.588.96q.361.296.659.658c.582.709.837 1.557.96 2.588q.04.348.064.739c.786-.392 1.452-.714 2.007-.896c.652-.213 1.343-.299 1.98.095s.87 1.05.97 1.728c.097.655.097 1.516.097 2.551v.416c0 1.035 0 1.896-.097 2.55c-.1.679-.333 1.335-.97 1.729s-1.328.308-1.98.095c-.555-.182-1.221-.504-2.007-.896q-.023.391-.065.739c-.122 1.03-.377 1.88-.96 2.588q-.296.361-.658.659c-.709.582-1.557.837-2.588.96c-1.005.118-2.274.118-3.876.118H9.45c-1.602 0-2.872 0-3.876-.119c-1.03-.122-1.88-.377-2.588-.96a5 5 0 0 1-.659-.658c-.582-.709-.837-1.557-.96-2.588c-.118-1.005-.118-2.274-.118-3.876V11.45c0-1.602 0-2.872.119-3.876c.122-1.03.377-1.88.96-2.588a5 5 0 0 1 .658-.659c.709-.582 1.557-.837 2.588-.96C6.58 3.25 7.85 3.25 9.451 3.25m6.799 9.25v-1c0-1.662-.001-2.843-.108-3.749c-.105-.889-.304-1.415-.63-1.813a3.3 3.3 0 0 0-.45-.45c-.398-.326-.924-.525-1.813-.63c-.906-.107-2.087-.108-3.749-.108s-2.843.001-3.749.108c-.889.105-1.415.304-1.813.63a3.3 3.3 0 0 0-.45.45c-.326.398-.525.924-.63 1.813c-.107.906-.108 2.087-.108 3.749v1c0 1.662.001 2.843.108 3.749c.105.889.304 1.415.63 1.813q.203.247.45.45c.398.326.924.525 1.813.63c.906.107 2.087.108 3.749.108s2.843-.001 3.749-.108c.889-.105 1.415-.304 1.813-.63q.247-.203.45-.45c.326-.398.525-.924.63-1.813c.107-.906.108-2.087.108-3.749m1.5 1.537l.244.121c.995.498 1.666.831 2.176.998c.499.163.65.1.724.055s.198-.153.275-.673c.079-.53.081-1.28.081-2.392v-.292c0-1.113-.002-1.862-.08-2.392c-.078-.52-.202-.627-.276-.673s-.225-.108-.724.055c-.51.167-1.18.5-2.176.998l-.244.122v4.072" clip-rule="evenodd"/></svg>
                        </a>
                      </li>
                </ul>
              </div>
              <div class="d-flex parent-chat-box">
                <div class="chat-box w-xs-100">
                  <div class="chat-box-inner p-9" data-simplebar="init">
                    <div class="simplebar-wrapper" style="margin: -20px;">
                      <div class="simplebar-height-auto-observer-wrapper">
                        <div class="simplebar-height-auto-observer"></div>
                      </div>
                      <div class="simplebar-mask">
                        <div class="simplebar-offset" style="right: 0px; bottom: 0px;">
                          <div class="simplebar-content-wrapper" tabindex="0" role="region"
                            aria-label="scrollable content" id="chat_messages_scroller" style="height: 100%; overflow: scroll;">
                            <div class="simplebar-content" style="padding: 20px;">
                                <div class="chat-list chat active-chat" data-user-id="1" id="chatMessages">
                                    {% for message in messages %}
                                        {% if message.etudiant.id != request.session.user_id %}
                                            <div class="hstack gap-3 align-items-start mb-7 justify-content-start">
                                                <img src="{{message.etudiant.photo_profil}}" alt="user8" width="40" height="40" class="rounded-circle">
                                                <div>
                                                    <h6 class="fs-2 text-muted">
                                                    {{ message.etudiant.nom }} {{ message.etudiant.prenom }}, {{ message.date_envoi }}
                                                    </h6>
                                                    <div class="p-2 text-bg-light rounded-1 d-inline-block text-dark fs-3">
                                                        {{ message.contenu }}
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="hstack gap-3 align-items-start mb-7 justify-content-end">
                                                <div class="text-end">
                                                    <h6 class="fs-2 text-muted">{{message.date_envoi}}</h6>
                                                    <div class="p-2 bg-info-subtle text-dark rounded-1 d-inline-block fs-3">
                                                        {{message.contenu}}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                               </div> 
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="simplebar-placeholder" style="width: 368px; height: 631px;"></div>
                    </div>
                    <div class="simplebar-track simplebar-horizontal" style="visibility: hidden;">
                      <div class="simplebar-scrollbar" style="width: 0px; display: none;"></div>
                    </div>
                    <div class="simplebar-track simplebar-vertical" style="visibility: hidden;">
                      <div class="simplebar-scrollbar" style="height: 0px; display: none;"></div>
                    </div>
                  </div>
                <div class="px-9 py-6 border-top chat-send-message-footer">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center justify-content-between">
                            <form method="post">
                                {% csrf_token %}
                                <input type="text" id="messageInput" class="form-control message-type-box text-muted border-0 rounded-0 p-0 ms-2" placeholder="Type a Message">
                                <button type="button" class="btn btn-primary ms-2" onclick="sendMessage()">Envoyer</button>
                            </form>
                        </div>
                    </div> 
                </div>
              </div>
            </div>
          </div>
      </div> 
  </div>

<script>
    // Identifiants du groupe et de l'√©tudiant (√† modifier selon vos besoins)
    const groupeId = '{{ request.session.groupe_id }}';
    const etudiantId = '{{request.session.user_id}}';

    // Fonction qui √©tablit la connexion WebSocket et configure les callbacks
    function connectWebSocket() {
        // Cr√©er une nouvelle connexion WebSocket
        let socket = new WebSocket(`ws://${window.location.hostname}:8000/ws/chat/`);

        // Lors de l'ouverture de la connexion, envoyer l'action "join"
        socket.onopen = function() {
            console.log("‚úÖ Connexion WebSocket √©tablie !");
            socket.send(JSON.stringify({
                'action': 'join',
                'groupe_id': groupeId,
                'etudiant_id': etudiantId
            }));
        };

        // En cas d'erreur sur la connexion
        socket.onerror = function(error) {
            console.error("‚ùå Erreur WebSocket :", error);
        };

        // Lors de la fermeture de la connexion
        socket.onclose = function(event) {
            console.warn(`‚ö† Connexion ferm√©e : Code=${event.code}, Raison=${event.reason}`);
            if (event.code === 1006) {
                console.error("La connexion a √©t√© ferm√©e de mani√®re inattendue.");
            }
            // Tentative de reconnexion apr√®s 5 secondes
            setTimeout(function() {
                console.log("Tentative de reconnexion...");
                // Mettre √† jour la variable globale "socket" avec la nouvelle connexion
                socket = connectWebSocket();
                window.socket = socket; // Mettez √† jour la variable globale si n√©cessaire
            }, 5000);
        };

        // Lors de la r√©ception d'un message depuis le serveur
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log("Message re√ßu :", data);
            const chatMessages = document.getElementById('chatMessages');

            // Affichage des messages en fonction de l'exp√©diteur
            if (data.etudiant_id != etudiantId) {
                chatMessages.innerHTML += `
                    <div class="hstack gap-3 align-items-start mb-7 justify-content-start">
                        <div>
                            <h6 class="fs-2 text-muted">${data.etudiant_nom}, ${data.date_envoi}</h6>
                            <div class="p-2 text-bg-light rounded-1 d-inline-block text-dark fs-3">${data.message}</div>
                        </div>
                    </div>
                `;
            } else {
                chatMessages.innerHTML += `
                    <div class="hstack gap-3 align-items-start mb-7 justify-content-end">
                        <div class="text-end">
                            <h6 class="fs-2 text-muted">${data.date_envoi}</h6>
                            <div class="p-2 bg-info-subtle text-dark rounded-1 d-inline-block fs-3">${data.message}</div>
                        </div>
                    </div>
                `;
            }
            // Auto-scroll vers le bas
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        return socket;
    }

    // Initialisation de la connexion et stockage dans une variable globale
    let socket = connectWebSocket();
    window.socket = socket;  // Permet de mettre √† jour la variable en cas de reconnexion

    // Fonction pour envoyer un message
    function sendMessage() {
        // V√©rifier que la connexion est ouverte
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            console.error("La connexion WebSocket est ferm√©e, impossible d'envoyer le message.");
            return;
        }
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (message !== '') {
            socket.send(JSON.stringify({
                'action': 'send_message',
                'message': message,
                'etudiant_id': etudiantId,
                'groupe_id': groupeId
            }));
            messageInput.value = '';  // Vide le champ apr√®s envoi
        }
    }

    // Envoyer le message lorsque l'utilisateur appuie sur la touche "Entr√©e"
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

  // Appel Video
  document.addEventListener("DOMContentLoaded", function () {
    const videoCallButton = document.getElementById("videoCallButton");
    const voiceCallButton = document.getElementById("voiceCallButton");

    // Fonction pour d√©marrer l'appel vid√©o
    function startVideoCall() {
        const videoContainer = document.createElement("div");
        videoContainer.innerHTML = `
            <div id="videoCallModal" class="video-call-modal">
                <div class="video-call-content">
                    <video id="localVideo" autoplay playsinline></video>
                    <button id="endCall">üõë Fin de l'appel</button>
                </div>
            </div>
        `;
        document.body.appendChild(videoContainer);

        const videoCallModal = document.getElementById('videoCallModal');
        const videoCallContent = document.querySelector('.video-call-content');
        const endCallButton = document.getElementById("endCall");

        applyModalStyles(videoCallModal);
        applyContentStyles(videoCallContent);
        applyButtonStyles(endCallButton);

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                const localVideo = document.getElementById("localVideo");
                localVideo.srcObject = stream;

                // Gestion de la fin de l'appel
                endCallButton.addEventListener("click", function () {
                    stream.getTracks().forEach(track => track.stop());
                    videoCallModal.remove();
                    console.log("üö´ Appel termin√©.");
                });

                // Envoyer le flux vid√©o √† d'autres utilisateurs via WebSocket (√† impl√©menter)
            })
            .catch(error => {
                console.error("Erreur d'acc√®s √† la cam√©ra/micro :", error);
            });
    }

    // Fonction pour d√©marrer l'appel vocal
    function startVoiceCall() {
        console.log("D√©marrage de l'appel vocal...");

        const voiceCallContainer = document.createElement("div");
        voiceCallContainer.innerHTML = `
            <div id="voiceCallModal" class="voice-call-modal">
                <div class="voice-call-content">
                    <button id="endVoiceCall">üõë Fin de l'appel vocal</button>
                </div>
            </div>
        `;
        document.body.appendChild(voiceCallContainer);

        const voiceCallModal = document.getElementById('voiceCallModal');
        const voiceCallContent = document.querySelector('.voice-call-content');
        const endVoiceCallButton = document.getElementById("endVoiceCall");

        applyModalStyles(voiceCallModal);
        applyContentStyles(voiceCallContent);
        applyButtonStyles(endVoiceCallButton);

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                console.log("Flux audio r√©cup√©r√©.");

                // Gestion de la fin de l'appel vocal
                endVoiceCallButton.addEventListener("click", function () {
                    stream.getTracks().forEach(track => track.stop());
                    voiceCallModal.remove();
                    console.log("üö´ Appel vocal termin√©.");
                });

                // Envoyer le flux audio √† d'autres utilisateurs via WebSocket (√† impl√©menter)
            })
            .catch(error => {
                console.error("Erreur d'acc√®s au microphone :", error);
            });
    }

    // √âcouteurs d'√©v√©nements pour les boutons
    if (videoCallButton) {
        videoCallButton.addEventListener("click", startVideoCall);
    }

    if (voiceCallButton) {
        voiceCallButton.addEventListener("click", startVoiceCall);
    }

    // Fonctions pour appliquer les styles (√† impl√©menter selon votre design)
    function applyModalStyles(modal) {
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.backgroundColor = "rgba(0,0,0,0.7)";
        modal.style.display = "flex";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
    }

    function applyContentStyles(content) {
        content.style.background = "white";
        content.style.padding = "20px";
        content.style.borderRadius = "10px";
        content.style.textAlign = "center";
    }

    function applyButtonStyles(button) {
        button.style.padding = "10px 20px";
        button.style.marginTop = "10px";
        button.style.cursor = "pointer";
        button.style.background = "red";
        button.style.color = "white";
        button.style.border = "none";
        button.style.borderRadius = "5px";
    }
});

</script>
{% endblock content %}


